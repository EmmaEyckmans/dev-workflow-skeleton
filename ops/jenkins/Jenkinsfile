/********** Global variables **********/
JENKINS_GIT_USERNAME = "jenkins-dws"
JENKINS_GIT_EMAIL = "j1291760@trbvm.com"

VERSION_NUMBER = ""
NO_OPTIONS = ""

/***** Networks *****/
JENKINS_NETWORK = "dws-jenkins"

/***** Images *****/
MVN_IMAGE = "dws/mvn"
MVN_FRONTEND_IMAGE = "dws/mvn-front-end"
MVN_E2E_IMAGE = "dws/mvn-e2e"
DB_CLEAN_IMAGE = "dws/db"
DB_MIGRATED_IMAGE = "dws/db-migrated"
BACKEND_IMAGE = "dws/back-end"
FRONTEND_IMAGE = "dws/front-end"

/***** Containers *****/
JENKINS_MAVEN_NAME = "dws_jenkins_mvn"
COMMIT_DB_NAME = "dws_jenkins_db_commit"
TEST_DB_NAME = "dws_jenkins_db_test"
TEST_BACKEND_NAME = "dws_jenkins_back-end_test"
TEST_FRONTEND_NAME = "dws_jenkins_front-end_test"

/*********** Build workflow ***********/
stage name: "commit"
	node("linux && docker") {
		cleanWorkspace()
		cloneProject()
		determineVersionNumber()
		setMvnVersion()
		buildCleanDbImage()
		buildMigratedDbImage()
		buildWithoutE2ETests()
		stopWhenFailures()
		stashWorkspace()
	}

stage name: "test"
	node("linux && docker") {
		unstashWorkspace()
		buildDockerImages()
		e2eTests()
		stopWhenFailures()
		tag()
	}

/********** Helper functions **********/
def cleanWorkspace() {
	sh "rm -rf *"
}

def cloneProject() {
	git credentialsId: "385df167-99f7-408d-b9d8-ad982a7c997b", url: "https://github.com/cegeka/dev-workflow-skeleton.git"
}	

def determineVersionNumber() {
	sh "git rev-list --count HEAD > nb-commits.txt"
	def nbCommits = readFile("nb-commits.txt").trim()
	VERSION_NUMBER = "0.0.${nbCommits}"
}

def setMvnVersion() {
	mvn("versions:set -DnewVersion=${VERSION_NUMBER} -DgenerateBackupPoms=false", MVN_IMAGE, JENKINS_NETWORK)
}

def buildWithoutE2ETests() {
	def dbName = "${COMMIT_DB_NAME}_${VERSION_NUMBER}"
	
	try {
		startContainer(DB_MIGRATED_IMAGE, dbName, JENKINS_NETWORK, NO_OPTIONS)
		mvn("clean install -Djenkins -Ddb.host=${dbName}:5432 -pl '!:dws-acc-tests'", MVN_FRONTEND_IMAGE, JENKINS_NETWORK)
	} catch(err) {
		printError(err)
		currentBuild.result  = "FAILURE"
	} finally {
		removeContainer(dbName)
		archiveAllTestResults()
		archiveArtifacts()
	}
}

def e2eTests() {
	def dbName = "${TEST_DB_NAME}_${VERSION_NUMBER}"
	def backendName = "${TEST_BACKEND_NAME}_${VERSION_NUMBER}"
	def frontendName = "${TEST_FRONTEND_NAME}_${VERSION_NUMBER}"

	try {
		startApplication(dbName, backendName, frontendName)
		mvn("clean install -Djenkins -DfrontendHost=${frontendName}:80 -DbackendHost=${backendName}:8080 -pl :dws-acc-tests", MVN_E2E_IMAGE, JENKINS_NETWORK)
	} catch(err) {
		printError(err)
		currentBuild.result  = "FAILURE"
	} finally {
		stopApplication(dbName, backendName, frontendName)
		archiveUiTestResults()
	}
}	

def tag() {
	sh "git config user.name '${JENKINS_GIT_USERNAME}'"
	sh "git config user.email '${JENKINS_GIT_EMAIL}'"
	sh "git config push.default 'simple'"

	sh "git tag -a ${VERSION_NUMBER} -m 'Tag version ${VERSION_NUMBER}'"
	sh "git push origin ${VERSION_NUMBER}"
}

def mvn(task, mvnImageName, network) {
	def mvnName = "${JENKINS_MAVEN_NAME}_${VERSION_NUMBER}"

	try {
		startMvnContainer(mvnImageName, mvnName, network)
		execMvn(mvnName, task)	
	} catch(err) {
		printError(err)
		currentBuild.result  = "FAILURE"
	} finally {
		removeContainer(mvnName)
	}
}

def archiveAllTestResults() {
	step([$class: "JUnitResultArchiver", testResults: "**/target/surefire-reports/TEST-*.xml"])
	step([$class: "JUnitResultArchiver", testResults: "**/target/failsafe-reports/TEST-*.xml"])
}

def archiveUiTestResults() {
	step([$class: "JUnitResultArchiver", testResults: "**/dws-acc-tests/target/surefire-reports/TEST-*.xml"])
	step([$class: "JUnitResultArchiver", testResults: "**/dws-acc-tests/target/failsafe-reports/TEST-*.xml"])
}

def archiveArtifacts() {
 	step([$class: "ArtifactArchiver", artifacts: "**/target/*.jar", fingerprint: true])
 	step([$class: "ArtifactArchiver", artifacts: "**/dws-ui/target/dist/**/*", fingerprint: true])
}

def stopWhenFailures() {
	if (currentBuild.result != null && !currentBuild.result.equalsIgnoreCase("STABLE")) {
	    error "There are failures in the current stage. The current build will be stopped."
	}
}

def stashWorkspace() {
	stash includes: '**/*', name: 'workspace', useDefaultExcludes: false
}

def unstashWorkspace() {
	unstash "workspace"
}

def printError(error) {
	println "******************************* WORKFLOW ERROR *******************************"
	println "${error}"
	println "******************************************************************************"
}

/********** DWS Docker functions **********/
def buildDockerImages() {
	buildCleanDbImage()
	buildBackendImage()
	buildFrontendImage()
}

def buildCleanDbImage() {
	sh "docker build -t ${DB_CLEAN_IMAGE}:${VERSION_NUMBER} ops/dws/db/clean/"
}

def buildMigratedDbImage() {
	sh "(echo 'FROM dws/db:${VERSION_NUMBER}' && cat ops/dws/db/migrated/Dockerfile.template) > ops/dws/db/migrated/Dockerfile"
	sh "mkdir -p ops/dws/db/migrated/db/migration"
	sh "cp -r dws/dws-infrastructure/src/main/resources/db/migration/* ops/dws/db/migrated/db/migration/"
	sh "docker build -t ${DB_MIGRATED_IMAGE}:${VERSION_NUMBER} ops/dws/db/migrated/"
}

def buildBackendImage() {
	sh "mkdir ops/dws/back-end/dws-jar"
	sh "cp dws/dws-rest/target/dws-rest-${VERSION_NUMBER}.jar ops/dws/back-end/dws-jar/dws-rest.jar"
	dir("ops/dws/back-end") {
		sh "docker build -t ${BACKEND_IMAGE}:${VERSION_NUMBER} ."
	}
}

def buildFrontendImage() { 
	sh "mkdir ops/dws/front-end/dws-dist"
	sh "cp -r dws/dws-ui/target/dist/* ops/dws/front-end/dws-dist/"
	dir("ops/dws/front-end") {
		sh "docker build -t ${FRONTEND_IMAGE}:${VERSION_NUMBER} ."
	}
}

def startApplication(dbName, backendName, frontendName) {
	startContainer(DB_MIGRATED_IMAGE, dbName, JENKINS_NETWORK, NO_OPTIONS)
	startContainer(BACKEND_IMAGE, backendName, JENKINS_NETWORK, "--env db.host=${dbName}:5432")
	startContainer(FRONTEND_IMAGE, frontendName, JENKINS_NETWORK, "--env dws_api_proxy=${backendName}:8080")
}

def stopApplication(dbName, backendName, frontendName) {
	removeContainer(frontendName)
	removeContainer(backendName)
	removeContainer(dbName)
}

/********** Basic Docker functions **********/
def startContainer(imageName, containerName, network, options) {
	killContainer(containerName)
	sh "docker run -d --net ${network} --name ${containerName} ${options} ${imageName}:${VERSION_NUMBER}"
}

def startMvnContainer(mvnImageName, mvnContainerName, network) {
	def currentDir = pwd()
	killContainer(mvnContainerName)
	sh "docker run -t -d --name ${mvnContainerName} --net ${network} -v $currentDir/dws:/usr/src/dws -v /var/jenkins_home/.m2:/root/.m2 ${mvnImageName}"
}

def execMvn(mvnContainerName, task) {
	sh "docker exec ${mvnContainerName} mvn -B -Dmaven.test.failure.ignore=true ${task}"
}

def killContainer(name) {
	try { sh "docker rm -vf ${name}" } catch(err) {}	
}

def removeContainer(name) {
	try { sh "docker stop ${name}" } catch(err){}
	try { sh "docker rm -v ${name}" } catch(err){}
}