/* global __dirname */

import gulp from "gulp";
import runSequence from "run-sequence";
import del from "del";
import babel from "gulp-babel";
import ngAnnotate from "gulp-ng-annotate";
import eslint from "gulp-eslint";
import imagemin from "gulp-imagemin";
import pngquant from "imagemin-pngquant";
import mainBowerFiles from "main-bower-files";
import browserSync from "browser-sync";
import concat from "gulp-concat";
import karma from "karma";
import csslint from "gulp-csslint";
import plumber from "gulp-plumber";
// import gutil from "gulp-util";
// import uglify from "gulp-uglify";

const server = browserSync.create("dev-workflow-skeleton");

const dirs = {
    src: "src",
    dest: "dist"
};

const paths = {
    vendor: `${dirs.dest}/vendor`,
    html: "src/**/*.html",
    js: "src/app/**/*.js",
    test: "test/unit/**/*.spec.js",
    css: "src/assets/css/*",
    img: "src/assets/img/*",
    ngNewRouter: `node_modules/angular-new-router/dist/router.es5.js`,
    babelPolyfill: `node_modules/babel-polyfill/dist/polyfill.js`,
    bower: "bower.json",
    gulp: "gulpfile.babel.js",
    karma: "karma.conf.js"
};

let test = singleRunEnabled => {
    return callback => {
        new karma.Server({
<<<<<<< HEAD
            configFile: `${__dirname}/test/${paths.karma}`,
=======
            configFile: `${__dirname}/test/unit/karma.conf.js`,
>>>>>>> moved karma tests to dist
            singleRun: singleRunEnabled
        },
        callback)
        .start();
    };
};
let testSingleRun = test(true);

gulp.task("default", callback =>
    runSequence("clean", "build", callback)
);

gulp.task("clean", () =>
    del(dirs.dest)
);

gulp.task("dev", callback =>
    runSequence("clean", ["build", "watch"], "serve", callback)
);

gulp.task("build", ["build:app", "build:assets", "build:vendor", "build:test"], testSingleRun);

gulp.task("build:app", ["jslint", "build:app:js", "build:app:html"]);

<<<<<<< HEAD
gulp.task("build:assets", ["csslint", "build:assets:css", "build:assets:img"]);
=======
gulp.task("build:test", () =>
    gulp.src(paths.test)
    .pipe(babel({
        moduleIds: true,
        presets: ["es2015"],
        plugins: ["transform-es2015-modules-systemjs"]
    }))
    .pipe(gulp.dest(`${dirs.dest}/test/unit`))
);

gulp.task("build:assets", ["build:assets:css", "build:assets:img"]);
>>>>>>> moved karma tests to dist

gulp.task("build:vendor", ["build:vendor:npm", "build:vendor:bower"]);

gulp.task("watch", () => {
    gulp.watch(paths.html, ["build:app:html"]);
    gulp.watch(paths.js, ["jslint", "build:app:js"]);
    gulp.watch(paths.css, ["csslint", "build:assets:css"]);
    gulp.watch(paths.img, ["build:assets:img"]);
    gulp.watch(paths.bower, ["build:vendor:bower"]);
});

gulp.task("build:app:js", () =>
    gulp
    .src(paths.js)
    .pipe(plumber())
    .pipe(babel({
        moduleIds: true,
        presets: ["es2015"],
        plugins: ["transform-es2015-modules-systemjs"]
    }))
    .pipe(ngAnnotate())
    // .pipe(uglify())
    .pipe(concat("main.js"))
    .pipe(gulp.dest(`${dirs.dest}/app`))
);

gulp.task("build:app:html", () =>
    gulp
    .src(paths.html)
    .pipe(gulp.dest(dirs.dest))
);

gulp.task("build:assets:css", () =>
    gulp
    .src(paths.css, {
        base: dirs.src
    })
    .pipe(gulp.dest(dirs.dest))
);

gulp.task("build:assets:img", () =>
    gulp
    .src(paths.img, {
        base: dirs.src
    })
    .pipe(plumber())
    .pipe(imagemin({
        progressive: true,
        use: [pngquant()]
    }))
    .pipe(gulp.dest(dirs.dest))
);

gulp.task("build:vendor:bower", () =>
    gulp
    .src(mainBowerFiles({
        checkExistence: true
    }))
    .pipe(gulp.dest(paths.vendor))
);

gulp.task("build:vendor:npm", () =>
    gulp
    .src([paths.ngNewRouter, paths.babelPolyfill])
    .pipe(gulp.dest(paths.vendor))
);

gulp.task("jslint", () =>
    gulp.src([paths.gulp, paths.karma, paths.js])
    .pipe(eslint())
    .pipe(eslint.format())
    //.pipe(eslint.failAfterError())
);

gulp.task("csslint", () =>
    gulp.src(paths.css)
    .pipe(csslint())
    .pipe(csslint.reporter("compact"))
    //.pipe(csslint.failReporter())
);

gulp.task("build:test", () =>
    gulp.src(paths.test)
    .pipe(babel({
        moduleIds: true,
        presets: ["es2015"],
        plugins: ["transform-es2015-modules-systemjs"]
    }))
    .pipe(gulp.dest(`${dirs.dest}/test`))
);

gulp.task("serve", () =>
    server.init({
        // ui: {
        //     port: 8081
        // },
        port: 8080,
        server: {
            baseDir: dirs.dest
        },
        files: `${dirs.dest}/**/*`
    })
);
